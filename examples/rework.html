<html>
<head>
  <meta name="viewport" content="width=720">
  <meta charset="utf-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<script type="module" type="text/javascript">
import { c, body, attr } from 'https://frameorc.github.io/src/dom.js';
import { methods } from '../../vendetta-themes/methods/default.js';

const NODES = Symbol('VENDETTA_NODES');
const Node = (data) => ({
  selector: '',
  media: '',
  data: data
});
const StyleNode = (...args) => Node([
  args.length == 1
  ? { classname: 'CSS(' + JSON.stringify(args[0]) + ')', style: args[0] }
  : { classname: args[0], style: args[1] }
]);
const MethodNode = (methods, name, args) => Node([{
  classname: name + '(' + args.join(',') + ')',
  style: () => methods[name](...args)
}]);

const toNodes = obj => Array.isArray(obj) ? obj : StyleNode(obj);
const reduceNodes = nodes => {
  const res = {};
  for (const node of nodes) {
    const n = res[node.selector + node.media] ??= Node([]);
    n.selector = node.selector;
    n.media = node.media;
    n.data.push(...node.data);
  }
  return Object.values(res);
}


const operators = {
  Sel: (arg, ...nodes) => {
    const func = typeof arg == 'function' ? arg
      : arg.includes('&') ? val => arg.replaceAll('&', val)
      : val => val + arg;
    nodes = nodes.flatMap(toNodes).map(node => ({
      ...node,
      selector: func(node.selector)
    }));
    return reduceNodes(nodes)
  },
  Media: (arg, ...nodes) => {
    nodes = nodes.flatMap(toNodes).map(node => ({
      ...node,
      media: node.media ? node.media + ' and ' + arg : arg
    }));
    return reduceNodes(nodes)
  }
}

const V = methods => {
  const methodNames = Object.keys(methods);
  for (const name of methodNames)
    if (name[0].toLowerCase() != name[0]) throw new Error(
      `Method names should start with lowercase characters (method: ${name})`
    );
  const methodsRoot = nodes => {
    const res = nodes;
    for (const name of methodNames)
      res[name] = (...args) => methodsRoot(
        nodes.concat(MethodNode(methods, name, args))
      );
    return res;
  }
  const func = (...args) => [StyleNode(...args)];
  const v = Object.assign(func, methodsRoot([]), operators);
  return { v };
}

const {v, stylesheet} = V(
  methods({
    unit: [8, 'px'],
    color: {
      T: 'transparent',
      t0: '#222',
      t1: '#2196f3',
      c0: '#fff',
      c1: '#eaeef0',
    },
    textSize: {
      sm: '12px',
      md: '16px',
      lg: '24px'
    },
    shadow: {
      sm: '0 2px 8px -3px rgba(0, 0, 0, 0.2)',
      md: '0 6px 16px -2px rgba(0, 0, 0, 0.4)',
    }
  })
);

/*
v.Sel(':hover', ...)
v.Media('screen', ...)
v.Animation('1s infinite', {
  0: v.tc`red`,
  100: v.tc`blue`
})
*/

console.log(
  v({ color: 'red' }),
  v.tc`red`,
  v.Media('screen', v.Sel(':hover', { color: 'red' }))
)
body(
  
);
body.refresh();
</script>
</html>
